<?php
require __DIR__ . '/../vendor/autoload.php';

use SecurePayload\SecurePayload;
use SecurePayload\Exceptions\SecurePayloadException;

// Setup: Shared secrets
$clientId = 'attacker';
$keyId = 'key1';
$hmacSecret = 'super-secret-key';

echo "--- Simulating Attack on FIXED Server ---\n";

// 1. Attacker constructs a valid signature for an INNOCENT request
$innocentMethod = 'GET';
$innocentPath = '/public/info';
$ts = (string) time();
$nonce = SecurePayload::genNonceB64();
$payload = ['data' => 'nothing suspicious'];
$bodyJson = json_encode($payload);
$digest = 'sha256=' . SecurePayload::bodyDigestB64($bodyJson);

// Canonical Request header still sent by attacker to try and fool server (though now ignored for verification truth)
$canonicalHeaderContent = base64_encode(implode("\n", [$innocentMethod, $innocentPath, '']));

// Manually craft HMAC for Innocent Request
$msgKey = implode("\n", [
    'v1',
    "client=$clientId",
    "key=$keyId",
    "ts=$ts",
    "nonce=$nonce",
    "m=$innocentMethod",
    "p=$innocentPath",
    "q=",
    "bd=$digest",
    ""
]);
$signature = base64_encode(hash_hmac('sha256', $msgKey, $hmacSecret, true));

$headers = [
    'X-Client-Id' => $clientId,
    'X-Key-Id' => $keyId,
    'X-Timestamp' => $ts,
    'X-Nonce' => $nonce,
    'X-Signature-Version' => '1',
    'X-Signature-Algorithm' => 'HMAC-SHA256',
    'X-Signature' => $signature,
    'X-Body-Digest' => $digest,
    'X-Canonical-Request' => $canonicalHeaderContent
];

$server = new SecurePayload([
    'mode' => 'hmac',
    'version' => '1',
    'keyLoader' => function ($c, $k) use ($hmacSecret) {
        return ['hmacSecret' => $hmacSecret];
    }
]);

// 2. Vulnerability Check
// In the fixed version, verifySimple REQUIREs the method and path to be passed in.
// We simulate the server receiving a "POST /admin/delete-user" request.
$actualMethod = 'POST';
$actualPath = '/admin/delete-user';

echo "Server processing: $actualMethod $actualPath\n";

try {
    // The server implementation now MUST pass the actual method/path to verifySimple
    $result = $server->verifySimple($headers, $bodyJson, $actualMethod, $actualPath);

    if ($result['ok']) {
        echo "[FAIL] Security Bypass Successful! Server accepted the spoofed request.\n";
        exit(1);
    } else {
        echo "[SUCCESS] Server rejected the request logically (Ok=false).\n";
        print_r($result);
    }
} catch (SecurePayloadException $e) {
    echo "[SUCCESS] Server rejected request with Exception: " . $e->getMessage() . "\n";
} catch (Exception $e) {
    echo "[SUCCESS] Server rejected request with generic Exception: " . $e->getMessage() . "\n";
}
